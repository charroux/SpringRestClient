<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns:int-groovy="http://www.springframework.org/schema/integration/groovy"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:jdbc="http://www.springframework.org/schema/jdbc"
       xmlns:int-jdbc="http://www.springframework.org/schema/integration/jdbc"
       xmlns:int-event="http://www.springframework.org/schema/integration/event"
       xmlns:int-script="http://www.springframework.org/schema/integration/scripting"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/context 
           http://www.springframework.org/schema/context/spring-context.xsd
           http://www.springframework.org/schema/integration
           http://www.springframework.org/schema/integration/spring-integration-4.2.xsd
           http://www.springframework.org/schema/integration/http
    	   http://www.springframework.org/schema/integration/http/spring-integration-http-4.2.xsd
           http://www.springframework.org/schema/integration/groovy
           http://www.springframework.org/schema/integration/groovy/spring-integration-groovy-4.2.xsd
           http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
           http://www.springframework.org/schema/integration/jdbc http://www.springframework.org/schema/integration/jdbc/spring-integration-jdbc-4.2.xsd
		   http://www.springframework.org/schema/jdbc http://www.springframework.org/schema/jdbc/spring-jdbc-4.2.xsd
		   http://www.springframework.org/schema/integration/event http://www.springframework.org/schema/integration/event/spring-integration-event-4.2.xsd
		   http://www.springframework.org/schema/integration/scripting
           http://www.springframework.org/schema/integration/scripting/spring-integration-scripting-4.2.xsd"> 
  
    
	<int:publish-subscribe-channel id="eventChannel"/>
	
	<int-event:outbound-channel-adapter channel="eventChannel"/>
	
	
	
	<int-event:inbound-channel-adapter channel="springContextEventChannel"
			event-types="org.springframework.context.event.ContextRefreshedEvent"/>
			
	<int:transformer input-channel="springContextEventChannel" output-channel="eventChannel">
   		<int-script:script lang="groovy" location="#{createReInitializedServiceEvent.input.adapter.file}" />
	</int:transformer>
	
	
	<!-- <int-script:variable name="bean" ref="beanForScript"/> -->
	
	<int:gateway id="gateway" default-request-channel="inputChannel" default-reply-channel="gatewayReplyChannel" service-interface="orchestrator.Gateway">
	</int:gateway>
	
	<int:channel id="inputChannel" />
	
	<int:header-enricher input-channel="inputChannel" output-channel="inputRouterChannel">
	     <int:header name="messageID" expression="headers['id'].toString()"/>
	     <int:header name="timestampSession" expression="@session.getSessionNumber()"/>
	</int:header-enricher>
	
	<int:channel id="gatewayReplyChannel" />

	<int:recipient-list-router input-channel="inputRouterChannel">
		<int:recipient channel="executorChannel"/>
		<int:recipient channel="inputEvtChannel"/>
	</int:recipient-list-router>
	
	
	
	<int:transformer input-channel="inputEvtChannel" output-channel="eventChannel">
   		<int-script:script lang="groovy" location="#{createIncomingMessageEvent.input.adapter.file}" />
	</int:transformer>
	

	
	
	
	
	<int:channel id="executorChannel">
		<int:dispatcher task-executor="executor" />
	</int:channel>
	
	<task:executor id="executor" pool-size="10" queue-capacity="10" rejection-policy="CALLER_RUNS" /> 
	
	<int:object-to-json-transformer input-channel="executorChannel" output-channel="httpChannel" />
		
	<int:channel id="httpChannel" />
	
	<int-http:outbound-gateway 
    request-channel="httpChannel"
    url-expression="'http://localhost:8080' + @code1.input.adapter.url + '?messageID={messageID}'"
    http-method-expression="@code1.input.adapter.method.name()"
    expected-response-type="org.olabdynamics.compose.Application"
    reply-channel="httpReplyChannel">
    	<int-http:uri-variable name="messageID" expression="headers['messageID'].toString()" />
    </int-http:outbound-gateway>
    
   	<int:channel id="httpReplyChannel" />
   
   	<int:transformer input-channel="httpReplyChannel" output-channel="ouputChannel" ref="transformer" method="transform" />
	
	<bean id="transformer" class="orchestrator.Transformer">
		<property name="application" ref="code1" />
	</bean>
	
	<int:transformer input-channel="ouputChannel" output-channel="outputRouterChannel" ref="finalTransformer" method="transform" />
	
	<bean id="finalTransformer" class="orchestrator.FinalTransformer">
		<property name="application" ref="application" />
	</bean>



	<int:recipient-list-router input-channel="outputRouterChannel">
		<int:recipient channel="gatewayReplyChannel"/>
		<int:recipient channel="outputEvtChannel"/>
	</int:recipient-list-router>
	
	<int:transformer input-channel="outputEvtChannel" output-channel="eventChannel">
   		<int-script:script lang="groovy" location="#{createOutgoingMessageEvent.input.adapter.file}" />
	</int:transformer>
	

	
	

<!-- 
	<int:logging-channel-adapter 
		channel="outputChannel"
		level="INFO" />  -->
	


</beans>